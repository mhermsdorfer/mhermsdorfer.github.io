<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Mark Hermsdorfer</title>
    <description>Hi, I&#39;m Mark Hermsdorfer, an operations architect with a focus on networking and application delivery infrastructure.  I write about various topics including my time as an F5 Networks consultant.</description>
    <link>http://blog.hermsdorfer.net/</link>
    <atom:link href="http://blog.hermsdorfer.net/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Mon, 04 Jun 2018 13:03:59 -0400</pubDate>
    <lastBuildDate>Mon, 04 Jun 2018 13:03:59 -0400</lastBuildDate>
    <generator>Jekyll v2.2.0</generator>
    
      <item>
        <title>Source MAC based routing</title>
        <description>&lt;p&gt;Several network/firwall vendors offer a feature that overrides the routing table to return traffic to the MAC address that initiated the connection.  The idea here is to store the MAC address that the SYN packet came from in the connection table, then when sending return traffic for that flow, to send it to the MAC address that the SYN came from.  This overrides the destination based routing table and helps prevent asymmetrical routing.  Depending upon your point of view, this is either very helpful or very confusing.&lt;/p&gt;

&lt;p&gt;This post simply catalogs the names various vendors call this feature.  There is no standard name, as such it can be very confusing when talking with different vendors.&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Vendor&lt;/th&gt;
      &lt;th&gt;Feature Name&lt;/th&gt;
      &lt;th&gt;Documentation Link&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;F5 Networks&lt;/td&gt;
      &lt;td&gt;Auto Last Hop (ALH)&lt;/td&gt;
      &lt;td&gt;&lt;a href=&quot;https://support.f5.com/csp/article/K13876&quot;&gt;K13876: Overview of the Auto Last Hop setting&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Palo Alto&lt;/td&gt;
      &lt;td&gt;Symmetric Return&lt;/td&gt;
      &lt;td&gt;&lt;a href=&quot;https://live.paloaltonetworks.com/t5/Configuration-Articles/How-to-Configure-Symmetric-Return/ta-p/59374&quot;&gt;How to Configure Symmetric Return&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;BlueCoat&lt;/td&gt;
      &lt;td&gt;Return-To-Sender (RTS)&lt;/td&gt;
      &lt;td&gt;&lt;a href=&quot;https://origin-symwisedownload.symantec.com/resources/webguides/cacheflow/3x/3_4/webguide/Content/CLI/config_return-to-send.htm&quot;&gt;RTS CLI Reference&lt;/a&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Check Point&lt;/td&gt;
      &lt;td&gt;unsure&lt;/td&gt;
      &lt;td&gt;I’m pretty sure this feature exists for checkpoint, however I can’t find it’s name&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
</description>
        <pubDate>Mon, 04 Jun 2018 06:54:25 -0400</pubDate>
        <link>http://blog.hermsdorfer.net/f5/ltm/afm/2018/06/04/Source-MAC-based-routing/</link>
        <guid isPermaLink="true">http://blog.hermsdorfer.net/f5/ltm/afm/2018/06/04/Source-MAC-based-routing/</guid>
        
        
        <category>f5</category>
        
        <category>ltm</category>
        
        <category>afm</category>
        
      </item>
    
      <item>
        <title>Server status pages for F5 monitoring</title>
        <description>&lt;p&gt;Automation is critical in our industry, however many companies opt for a less technically advanced self service play.  One trivially easy way to get some self-service with the F5 platform is though the use of status pages for pool member monitoring.&lt;/p&gt;

&lt;p&gt;In this scenario the application or server administrators setup a status page, that status page can be as complex as the application or server administrators like.  On the higher end it could be a jsp page that checks the status of various other services and databases reporting overall application health.  On the lower end it can be a simple static html page.&lt;/p&gt;

&lt;p&gt;By modifying the output of the status page the application administrators can indicate to the F5 if traffic should be sent to the server.  This allows server &amp;amp; application team members to perform maintenance on their servers without involvement from the F5 operators to disable pool member.&lt;/p&gt;

&lt;p&gt;For more details on monitor regex strings: &lt;a href=&quot;https://support.f5.com/kb/en-us/solutions/public/5000/900/sol5917.html&quot;&gt;Using regular expressions in a health monitor Receive String&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For more details on monitor disable strings: &lt;a href=&quot;https://support.f5.com/kb/en-us/solutions/public/12000/800/sol12818.html&quot;&gt;Using the Receive Disable String advanced configuration setting&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;configuration-example&quot;&gt;Configuration example&lt;/h2&gt;

&lt;p&gt;Here is an example static status page I’ve used previously.  There is nothing complex, it includes some details so operators can see their various status options.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;html&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;lang&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;en&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;meta&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;http-equiv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;content-type&amp;quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;content&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text/html; charset=UTF-8&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; Application Status Page &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;h1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; Application Status Page &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;h1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;h1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; status=up &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;h1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; Modify the current server status on header above, leaving no space between status= and expected status.  The server status can be set to various options as follows:
    &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;ul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; up or online:     Server is normal and eligible for all traffic. &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; quiesce or drain: Server is going offline and eligible only for existing sessions. &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt; down or offline:  Server is down and not eligible any traffic. &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;ul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;html&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here is an example HTTP status monitor on the F5 that works with the above status page.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;ltm monitor http /Common/status-http-monitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 5
    ip-dscp 0
    recv &amp;quot;status=(up|online)&amp;quot;
    recv-disable &amp;quot;status=(quiesce|disabled|drain)&amp;quot;
    send &amp;quot;GET /status.html HTTP/1.1\\r\\nHost: status.com\\r\\nConnection: close\\r\\n\\r\\n&amp;quot;
    time-until-up 0
    timeout 16
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The same monitor as above, except this one is for HTTPS.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;ltm monitor https /Common/status-https-monitor {
    adaptive disabled
    cipherlist DEFAULT:+SHA:+3DES:+kEDH
    compatibility enabled
    defaults-from /Common/https
    destination *:*
    interval 5
    ip-dscp 0
    recv &amp;quot;status=(up|online)&amp;quot;
    recv-disable &amp;quot;status=(quiesce|disabled|drain)&amp;quot;
    send &amp;quot;GET /status.html HTTP/1.1\\\\r\\\\nHost: status.com\\\\r\\\\nConnection: close\\\\r\\\\n\\\\r\\\\n&amp;quot;
    time-until-up 0
    timeout 16
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
        <pubDate>Thu, 09 Jul 2015 06:54:25 -0400</pubDate>
        <link>http://blog.hermsdorfer.net/f5/ltm/2015/07/09/f5-status-page/</link>
        <guid isPermaLink="true">http://blog.hermsdorfer.net/f5/ltm/2015/07/09/f5-status-page/</guid>
        
        
        <category>f5</category>
        
        <category>ltm</category>
        
      </item>
    
      <item>
        <title>LTM clone pools &amp; SSL Bridging</title>
        <description>&lt;p&gt;Security teams place intrusion detection devices (IDS) on the network in order to monitor network traffic for signs of intrusion.  Often this is accomplished with network taps and/or switch monitor ports, such setups provide the security team all packets on the network.  As companies migrate all sites to use SSL payloads are encrypted, and attack traffic looks the same as legitimate traffic.  What the security teams really need are the unencrypted traffic flows.&lt;/p&gt;

&lt;p&gt;F5 devices are high performance SSL platforms and often act as a central decryption/encryption point for applications.  As such, it makes for a great place to strip off ssl and send the decrypted flow to an IDS appliance.  Fortunately F5 makes such configurations easy with the clone pool feature.  Clone pools can be configured on a per virtual server basis, they copy the traffic from the proxies client-side or server-side.  This works great when you’re not running any SSL or the F5 is performing SSL offload.  In the of ssl offload you simply assign a clone-pool to the server-side of the proxy, and clear-text traffic is sent to the IDS systems.&lt;/p&gt;

&lt;p&gt;However, if the F5 is performing SSL bridging things get slightly more complex.  This is due to how the F5’s proxy chain or HUD chain works.  The clone pool action is performed very early on the client-side and very late on the server-side, in-fact it happens prior to ssl decryption on the client-side of the proxy and after ssl encryption on the server-side.  Because of this, we need to setup two VIPs, the first VIP will terminate ssl from the client, then send the cleartext http to another vip.  The second vip will then re-encrypt ssl and send the http request to servers.  We can then place a clone-pool on the server-side of the first vip and mirror unencrypted to our IDS system.&lt;/p&gt;

&lt;p&gt;For more details on clone pools see: &lt;a href=&quot;https://support.f5.com/kb/en-us/solutions/public/13000/300/sol13392.html#clone&quot;&gt;F5’s Configuring Configuring the BIG-IP system to send traffic to an intrusion detection system &lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;configuration-example&quot;&gt;Configuration example&lt;/h2&gt;

&lt;p&gt;Let’s walk though how to create a configuration using VIP targeting VIP for cloning cleartext traffic while the F5 performs SSL bridging.&lt;/p&gt;

&lt;p&gt;First create pools, one for the server-side traffic, the other for our IDS system that we’ll clone traffic to:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;ltm pool /Common/sitefoo.bar.com-clone-pool {
    members {
        /Common/ids-system:12345 {
            address 10.2.200.200
        }
    }
    monitor /Common/tcp_half_open
}
ltm pool /Common/sitefoo.bar.com-server-pool {
    members {
        /Common/venkman:443 {
            address 10.2.1.51
        }
    }
    monitor /Common/tcp_half_open
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next let’s create a server-side VIP.  This VIP will use a pool with the back-end web servers, and will have server-ssl but no client-ssl.  It will accept clear text http on it’s client-side and send ssl encrypted http to the servers on it’s server-side.&lt;/p&gt;

&lt;p&gt;NOTE: You should secure this virtual server such that it can-not be accessed by end-users, you can do this with AFM rules, or by using a non-routable destination address.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;ltm virtual /Common/sitefoo.bar.com-server-side-vip {
    destination /Common/10.1.50.160:8443
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/sitefoo.bar.com-server-pool
    profiles {
        /Common/http { }
        /Common/serverssl-insecure-compatible {
            context serverside
        }
        /Common/tcp { }
    }
    source 0.0.0.0/0
    source-address-translation {
        type automap
    }
    translate-address enabled
    translate-port enabled
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next let’s create an irule that targets the server-side vip from the client-side vip:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;ltm rule /Common/sitefoo.bar.com-vip-target-vip-ir {
    when HTTP_REQUEST {
    virtual sitefoo.bar.com-server-side-vip
}
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Finally, create a client-side VIP.  This VIP has a clientssl on the client-side of the proxy that terminates ssl, the clone-pool on the server-side of the proxy and finally the iRule that tells heh F5 to send traffic to the other virtual server.  Notably it does not have a default pool.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;ltm virtual /Common/sitefoo.bar.com-client-side-vip {
    clone-pools {
        /Common/sitefoo.bar.com-clone-pool {
            context serverside
        }
    }
    destination /Common/10.1.50.160:443
    ip-protocol tcp
    mask 255.255.255.255
    profiles {
        /Common/clientssl {
            context clientside
        }
        /Common/http { }
        /Common/tcp { }
    }
    rules {
        /Common/sitefoo.bar.com-vip-target-vip-ir
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
        <pubDate>Wed, 08 Jul 2015 06:54:25 -0400</pubDate>
        <link>http://blog.hermsdorfer.net/f5/ltm/2015/07/08/ssl-bridging-and-clone-pool/</link>
        <guid isPermaLink="true">http://blog.hermsdorfer.net/f5/ltm/2015/07/08/ssl-bridging-and-clone-pool/</guid>
        
        
        <category>f5</category>
        
        <category>ltm</category>
        
      </item>
    
      <item>
        <title>GTM Translation addresses for Generic Host objects</title>
        <description>&lt;p&gt;A reading of the &lt;a href=&quot;https://support.f5.com/kb/en-us/solutions/public/14000/700/sol14707.html&quot;&gt;F5’s Configuring BIG-IP GTM server objects for BIG-IP devices that reside behind a firewall NAT&lt;/a&gt; might lead one to believe that translation addresses for non BIG-IP server objects would have a similar effect as they do for BIG-IP objects.  However, translation addresses are ONLY supported by BIG-IP objects when using iQuery or the “bigip” health monitor in GTM.  The translation-address and translation-port configuration options have no impact on generic host or any other non-iquery monitored server or virtual server object.&lt;/p&gt;

&lt;p&gt;This can be frustrating, the user experience for this configuration is honestly pretty awful in the F5 web interface.  One would think that if translation addresses did nothing for non-iquery monitored server objects then the GUI &amp;amp; configuration objects would not allow their configuration which only causes further confusion.&lt;/p&gt;

&lt;p&gt;For an overview of split DNS configuration on the GTM see: &lt;a href=&quot;/f5/gtm/2014/12/23/split-dns-with-gtm/&quot;&gt;Spit DNS with GTM&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;broken-configuration&quot;&gt;Broken Configuration&lt;/h2&gt;

&lt;p&gt;The configuration below does not work as one might expect.  &lt;/p&gt;

&lt;p&gt;One likely expects the GTM to issue the following health monitors:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;gateway_icmp to 172.20.1.31 the server object address.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;tcp_half_open to 172.20.1.31:80 for the “GenericServer01-internal” virtual server object.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;tcp_half_open to 172.20.1.31:80 for the “GenericServer01-external” virtual server object, due to the inclusion of the translation-address &amp;amp; translation-port.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;gtm server /Common/GenericServer01 {
    addresses {
        172.20.1.31 {
            device-name GenericServer01
        }
    }
    datacenter /Common/DataCenter01
    monitor /Common/gateway_icmp
    virtual-servers {
        GenericServer01-external {
            destination 192.0.2.31:80
            monitor /Common/tcp_half_open
            translation-address 172.20.1.31
        }
        GenericServer01-internal {
            destination 172.20.1.31:80
            monitor /Common/tcp_half_open
        }
    }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;However what actually happens is as follows:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;gateway_icmp to 172.20.1.31 the server object address.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;tcp_half_open to 172.20.1.31:80 for the “GenericServer01-internal” virtual server object.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;tcp_half_open to 192.0.2.31:80 for the “GenericServer01-external” virtual server object, because translation addresses are ignored for non-iquery or bigip monitored objects.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This often leaves the public or external virtual server object marked down as many organizations do not configure their firewalls for &lt;a href=&quot;http://tools.ietf.org/html/rfc4787#section-6&quot;&gt;Hairpin nat&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;working-configuration&quot;&gt;Working Configuration&lt;/h2&gt;

&lt;p&gt;First, a few considerations, I’d argue the best possible fix is to setup public IP addresses on your LTMs and let them act as your primary edge device.  This puts all the management and configuration for your public presence on a highly secure, highly scalable, best of breed system.&lt;/p&gt;

&lt;p&gt;Failing using F5 LTM for all external IPs the next best fix is to setup or enable hairpin NAT on the firewall or router performing the external NAT.  In an ideal world the F5 would monitor via the public IP address so that if the device performing NAT goes down the F5 correctly marks the system as down.&lt;/p&gt;

&lt;p&gt;If all that is not possible and you must monitor the private address while handing out the public address then continue reading.  The way to configure a generic host server/virtual server object for NAT translation is to use alias addresses a health monitor assigned to the public virtual server object.  This should sound familiar from LTM, an alias address on a health monitor allows us to apply that health check to any arbitrary virtual server or server object in the GTM, while actually having the health check go to a different address/port.&lt;/p&gt;

&lt;p&gt;The disadvantage of this configuration is that you’ll end up creating and maintaining a lot of very specific GTM monitors with address aliases for all of your NATed generic objects.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;&lt;span&gt;&lt;/span&gt;gtm monitor tcp-half-open /Common/GenericServer01-tcp-half-open {
    defaults-from /Common/tcp_half_open
    destination 172.20.1.31:80
    interval 30
    probe-attempts 3
    probe-interval 1
    probe-timeout 5
    timeout 120
}
gtm server /Common/GenericServer01 {
    addresses {
        172.20.1.31 {
            device-name GenericServer01
        }
    }
    datacenter /Common/DataCenter01
    monitor /Common/gateway_icmp
    virtual-servers {
        GenericServer01-external {
            destination 192.0.2.31:80
            monitor /Common/GenericServer01-tcp-half-open
        }
        GenericServer01-internal {
            destination 172.20.1.31:80
            monitor /Common/tcp_half_open
        }
    }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Note: Unfortunately, GTM monitors require a destination IP and port if a specific IP is used.  Ideally we could configure a monitor with a specific destination address and a wildcard port.&lt;/li&gt;
&lt;/ul&gt;

</description>
        <pubDate>Tue, 23 Dec 2014 12:54:25 -0500</pubDate>
        <link>http://blog.hermsdorfer.net/f5/gtm/2014/12/23/GTM-Translation-addresses-for-Generic-Host-objects/</link>
        <guid isPermaLink="true">http://blog.hermsdorfer.net/f5/gtm/2014/12/23/GTM-Translation-addresses-for-Generic-Host-objects/</guid>
        
        
        <category>f5</category>
        
        <category>gtm</category>
        
      </item>
    
      <item>
        <title>Split DNS with GTM</title>
        <description>&lt;p&gt;NAT adds complexity to everything, I avoid it whenever possible, however it’s a necessary evil of our IPv4 world.  A common configuration that needs to be addressed in GTM deployments is NAT and split DNS.  Often the GTM will need to respond to internal queries with a private IP address while external queries get a public IP address.  This is typically done inside GTM with topology records and possibly a combination of internal and external pools containing different virtual server objects.&lt;/p&gt;

&lt;h1 id=&quot;avoid-split-dns-when-possible&quot;&gt;Avoid Split DNS when possible&lt;/h1&gt;
&lt;p&gt;I strongly advocate that administrators simply hand out external public IP addresses for anything that is externally accessible.  This allows you to avoid the entire problem space around split DNS and the additional configuration overhead and complexity it brings to your environment.  Many will argue about the inefficiency of configurations that use &lt;a href=&quot;http://tools.ietf.org/html/rfc4787#section-6&quot;&gt;Hairpin nat&lt;/a&gt;, the arguments typically revolve around hairpinning putting additional load on the NAT device &amp;amp; causing inefficient traffic flows on the network.  However, if there are capacity concerns about the NAT device, then what’s the expectation for when a syn-flood or other DOS attack hits the nat box from the Internet?  Additionally, complexity is every IT operations worst enemy, if you can reduce configuration complexity at the cost of a bigger firewall that’s a huge win.  Firewalls are cheap compared to outages and additional labor overhead caused by complexity.&lt;/p&gt;

&lt;p&gt;If however, hairpin nat is not an option for you, continue on.  &lt;a href=&quot;https://support.f5.com/kb/en-us/solutions/public/14000/700/sol14707.html&quot;&gt;F5’s Achieving split DNS behavior through BIG-IP GTM wide IPs&lt;/a&gt; walks you though the steps to configure split dns on GTM.  However it lacks configuration examples, this post is intended to clarify configurations where needed and to provide some example configuration snippets.&lt;/p&gt;

&lt;h1 id=&quot;sorry-work-in-progress&quot;&gt;Sorry work in progress…&lt;/h1&gt;

&lt;h1 id=&quot;using-translation-fields-in-virtual-server-objects&quot;&gt;Using Translation fields in virtual server objects&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;https://support.f5.com/kb/en-us/solutions/public/14000/700/sol14707.html&quot;&gt;F5’s Configuring BIG-IP GTM server objects for BIG-IP devices that reside behind a firewall NAT&lt;/a&gt; covers this fairly well.&lt;/p&gt;

&lt;h1 id=&quot;pool-creation&quot;&gt;Pool Creation&lt;/h1&gt;

&lt;h1 id=&quot;topology-records&quot;&gt;Topology Records&lt;/h1&gt;

&lt;h1 id=&quot;gluing-it-all-together&quot;&gt;Gluing it all together&lt;/h1&gt;

</description>
        <pubDate>Tue, 23 Dec 2014 10:32:34 -0500</pubDate>
        <link>http://blog.hermsdorfer.net/f5/gtm/2014/12/23/split-dns-with-gtm/</link>
        <guid isPermaLink="true">http://blog.hermsdorfer.net/f5/gtm/2014/12/23/split-dns-with-gtm/</guid>
        
        
        <category>f5</category>
        
        <category>gtm</category>
        
      </item>
    
  </channel>
</rss>
