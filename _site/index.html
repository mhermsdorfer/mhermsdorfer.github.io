<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Mark Hermsdorfer &middot; 
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/styles.css">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Mark Hermsdorfer" href="/atom.xml">
</head>



    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Mark Hermsdorfer</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          
            
              <a class="page-link" href="/about/">About</a>
            
          
        
          
        
          
            
              <a class="page-link" href="/">Home</a>
            
          
        
          
        
          
            
            
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
         <div class="post-content">
           <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/f5/ltm/2015/07/09/f5-status-page/">
        Server status pages for F5 monitoring
      </a>
    </h1>

    <time datetime="2015-07-09T06:54:25-04:00" class="post-date">09 Jul 2015</time>

    <p>Automation is critical in our industry, however many companies opt for a less technically advanced self service play.  One trivially easy way to get some self-service with the F5 platform is though the use of status pages for pool member monitoring.</p>

<p>In this scenario the application or server administrators setup a status page, that status page can be as complex as the application or server administrators like.  On the higher end it could be a jsp page that checks the status of various other services and databases reporting overall application health.  On the lower end it can be a simple static html page.</p>

<p>By modifying the output of the status page the application administrators can indicate to the F5 if traffic should be sent to the server.  This allows server &amp; application team members to perform maintenance on their servers without involvement from the F5 operators to disable pool member.</p>

<p>For more details on monitor regex strings: <a href="https://support.f5.com/kb/en-us/solutions/public/5000/900/sol5917.html">Using regular expressions in a health monitor Receive String</a></p>

<p>For more details on monitor disable strings: <a href="https://support.f5.com/kb/en-us/solutions/public/12000/800/sol12818.html">Using the Receive Disable String advanced configuration setting</a></p>

<h2 id="configuration-example">Configuration example</h2>

<p>Here is an example static status page I’ve used previously.  There is nothing complex, it includes some details so operators can see their various status options.</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span> Application Status Page <span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span> Application Status Page <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;h1&gt;</span> status=up <span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;p&gt;</span> Modify the current server status on header above, leaving no space between status= and expected status.  The server status can be set to various options as follows:
    <span class="nt">&lt;ul&gt;</span>
        <span class="nt">&lt;li&gt;</span> up or online:     Server is normal and eligable for all traffic. <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span> quiesce or drain: Server is going offline and eligable only for existing sessions. <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span> down or offline:  Server is down and not eligable any traffic. <span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></div>

<p>Here is an example HTTP status monitor on the F5 that works with the above status page.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">ltm monitor http /Common/status-http-monitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 5
    ip-dscp 0
    recv &quot;status=(up|online)&quot;
    recv-disable &quot;status=(quiesce|disabled|drain)&quot;
    send &quot;GET /status.html HTTP/1.1\\r\\nHost: status.com\\r\\nConnection: close\\r\\n\\r\\n&quot;
    time-until-up 0
    timeout 16
}</code></pre></div>

<p>The same monitor as above, except this one is for HTTPS.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">ltm monitor https /Common/status-https-monitor {
    adaptive disabled
    cipherlist DEFAULT:+SHA:+3DES:+kEDH
    compatibility enabled
    defaults-from /Common/https
    destination *:*
    interval 5
    ip-dscp 0
    recv &quot;status=(up|online)&quot;
    recv-disable &quot;status=(quiesce|disabled|drain)&quot;
    send &quot;GET /status.html HTTP/1.1\\\\r\\\\nHost: status.com\\\\r\\\\nConnection: close\\\\r\\\\n\\\\r\\\\n&quot;
    time-until-up 0
    timeout 16
}</code></pre></div>


  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/f5/ltm/2015/07/08/ssl-bridging-and-clone-pool/">
        LTM clone pools & SSL Bridging
      </a>
    </h1>

    <time datetime="2015-07-08T06:54:25-04:00" class="post-date">08 Jul 2015</time>

    <p>Security teams often want to place intrusion detection devices (IDS) on the network in order to monitor network traffic for signs of intrusion.  Often this is accomplished with network taps and/or switch monitor ports, such setups provide the security team all packets on the network.  Increasingly, the packets won’t tell the security team much due to SSL encryption.  If all payloads are encrypted, then an attackers traffic will look the same as legitimate traffic.  What the security teams really needs are unencrypted traffic flows.</p>

<p>The F5 is a high performance SSL platform and often acts as a central decryption/encryption point for applications.  As such, it makes for a great place to strip off ssl and send the decrypted flow to an IDS appliance.  Fortunately F5 makes such configurations easy with the clone pool feature, these can be configured per virtual server, and can copy the traffic from the proxies client-side or server-side.  This works great when you’re not running any SSL or the F5 is performing SSL offload, in the offload case you simply assign a clone-pool to the server-side of the proxy, and clear-text traffic is sent to the IDS systems.</p>

<p>However, if the F5 is performing ssl bridging things get slightly more complex.  This is due to how the F5’s proxy chain or HUD chain works.  The clone pool action is performed very early on the client-side and very late on the server-side, in-fact it happens prior to ssl decryption on the client-side of the proxy and after ssl encryption on the server-side.  Because of this, we need to setup two VIPs, the first VIP will terminate ssl from the client, then send the cleartext http to another vip.  The second vip will then re-encrypt ssl and send the http request to servers.  We can then place a clone-pool on the server-side of the first vip and mirror unencrypted to our IDS system.</p>

<p>For more details on clone pools see: <a href="https://support.f5.com/kb/en-us/solutions/public/13000/300/sol13392.html#clone">F5’s Configuring Configuring the BIG-IP system to send traffic to an intrusion detection system </a></p>

<h2 id="configuration-example">Configuration example</h2>

<p>Let’s walk though how to create a configuration using VIP targeting VIP for cloning cleartext traffic while the F5 performs SSL bridging.</p>

<p>First create pools, one for the server-side traffic, the other for our IDS system that we’ll clone traffic to:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">ltm pool /Common/sitefoo.bar.com-clone-pool {
    members {
        /Common/ids-system:12345 {
            address 10.2.200.200
        }
    }
    monitor /Common/tcp_half_open
}
ltm pool /Common/sitefoo.bar.com-server-pool {
    members {
        /Common/venkman:443 {
            address 10.2.1.51
        }
    }
    monitor /Common/tcp_half_open
}</code></pre></div>

<p>Next let’s create a server-side VIP.  This VIP will use a pool with the back-end web servers, and will have server-ssl but no client-ssl.  It will accept clear text http on it’s client-side and send ssl encrypted http to the servers on it’s server-side.</p>

<p>NOTE: You should secure this virtual server such that it can-not be accessed by end-users, you can do this with AFM rules, or by using a non-routable destination address.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">ltm virtual /Common/sitefoo.bar.com-server-side-vip {
    destination /Common/10.1.50.160:8443
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/sitefoo.bar.com-server-pool
    profiles {
        /Common/http { }
        /Common/serverssl-insecure-compatible {
            context serverside
        }
        /Common/tcp { }
    }
    source 0.0.0.0/0
    source-address-translation {
        type automap
    }
    translate-address enabled
    translate-port enabled
}</code></pre></div>

<p>Next let’s create an irule that targets the server-side vip from the client-side vip:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">ltm rule /Common/sitefoo.bar.com-vip-target-vip-ir {
    when HTTP_REQUEST {
    virtual sitefoo.bar.com-server-side-vip
}
}</code></pre></div>

<p>Finally, create a client-side VIP.  This VIP has a clientssl on the client-side of the proxy that terminates ssl, the clone-pool on the server-side of the proxy and finally the iRule that tells teh F5 to send traffic to the other virtual server.  Notably, it does not have a default pool.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">ltm virtual /Common/sitefoo.bar.com-client-side-vip {
    clone-pools {
        /Common/sitefoo.bar.com-clone-pool {
            context serverside
        }
    }
    destination /Common/10.1.50.160:443
    ip-protocol tcp
    mask 255.255.255.255
    profiles {
        /Common/clientssl {
            context clientside
        }
        /Common/http { }
        /Common/tcp { }
    }
    rules {
        /Common/sitefoo.bar.com-vip-target-vip-ir
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}</code></pre></div>


  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

<aside class="related">
  <h2>Recent Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/f5/ltm/2015/07/09/f5-status-page/">
            Server status pages for F5 monitoring
            <small><time datetime="2015-07-09T06:54:25-04:00">09 Jul 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/f5/ltm/2015/07/08/ssl-bridging-and-clone-pool/">
            LTM clone pools & SSL Bridging
            <small><time datetime="2015-07-08T06:54:25-04:00">08 Jul 2015</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/f5/gtm/2014/12/23/GTM-Translation-addresses-for-Generic-Host-objects/">
            GTM Translation addresses for Generic Host objects
            <small><time datetime="2014-12-23T12:54:25-05:00">23 Dec 2014</time></small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/f5/gtm/2014/12/23/split-dns-with-gtm/">
            Split DNS with GTM
            <small><time datetime="2014-12-23T10:32:34-05:00">23 Dec 2014</time></small>
          </a>
        </h3>
      </li>
    
  </ul>
</aside>

         </div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Mark Hermsdorfer</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Mark Hermsdorfer</li>
        <li><a href="mailto:mark@hermsdorfer.net">mark@hermsdorfer.net</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/mhermsdorfer">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">mhermsdorfer</span>
          </a>
        </li>
        
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">Hi, I'm Mark Hermsdorfer, an operations architect with a focus on networking and application delivery infrastructure.  I write about various topics including my time as an F5 Networks consultant.</p>
    </div>

  </div>

</footer>


    </body>
</html>
